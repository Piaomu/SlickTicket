@using SlickTicket.Services.Interfaces
@model SlickTicket.Models.Project
@inject IBTProjectService _projectService
@inject IImageService _imageService

@{
    var projectManager = await _projectService.GetProjectManagerAsync(Model.Id);
    ViewData["Title"] = "Details";
}



<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6 mb-2">
                    <h1>Project Details</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                        <li class="breadcrumb-item active">Details | @Model.Name</li>
                    </ol>
                </div>
            </div>
        </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">

        <!-- Default box -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Project: @Model.Name</h3>

                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button type="button" class="btn btn-tool" data-card-widget="remove" title="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12 col-md-12 col-lg-8 order-2 order-md-1">
                        <div class="row">
                            <div class="col-12 col-sm-4">
                                <div class="info-box bg-light">
                                    <div class="info-box-content">
                                        <span class="info-box-text text-center text-muted">End Date</span>
                                        <span class="info-box-number text-center text-muted mb-0">@string.Format("{0:MMM dd yyyy}", Model.EndDate)</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-sm-4">
                                @if (Model.ProjectPriority.Name == "Urgent")
                                {
                                    <div class="info-box bg-red">
                                        <div class="info-box-content">
                                            <span class="info-box-text text-center">Priority</span>
                                            <span class="info-box-number text-center mb-0">@Model.ProjectPriority.Name</span>
                                        </div>
                                    </div>
                                }
                                @if (Model.ProjectPriority.Name == "High")
                                {
                                    <div class="info-box bg-orange">
                                        <div class="info-box-content">
                                            <span class="info-box-text text-center">Priority</span>
                                            <span class="info-box-number text-center mb-0">@Model.ProjectPriority.Name</span>
                                        </div>
                                    </div>
                                }
                                @if (Model.ProjectPriority.Name == "Medium")
                                {
                                    <div class="info-box bg-yellow">
                                        <div class="info-box-content">
                                            <span class="info-box-text text-center">Priority</span>
                                            <span class="info-box-number text-center mb-0">@Model.ProjectPriority.Name</span>
                                        </div>
                                    </div>
                                }
                                @if (Model.ProjectPriority.Name == "Low")
                                {
                                    <div class="info-box bg-green">
                                        <div class="info-box-content">
                                            <span class="info-box-text text-center">Priority</span>
                                            <span class="info-box-number text-center mb-0">@Model.ProjectPriority.Name</span>
                                        </div>
                                    </div>
                                }

                            </div>
                            <div class="col-12 col-sm-4">
                                <div class="info-box bg-light">
                                    <div class="info-box-content">
                                        <span class="info-box-text text-center text-muted">Archived</span>
                                        <span class="info-box-number text-center text-muted mb-0">@ViewData["Archived"]</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <h4>Members</h4>
                                <div class="post">
                                    @foreach (var member in Model.Members)
                                    {
                                        <div class="user-block">
                                            <img class="img-circle img-bordered-sm" src="@_imageService.DecodeImage(member.AvatarFileData, member.AvatarContentType)" alt="user image">
                                            <span class="username">
                                                <a>@member.FullName</a>
                                            </span>
                                        </div>
                                        <!-- /.user-block -->
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-12 col-lg-4 order-1 order-md-2">
                        <h3 class="text-primary"><i class="fas fa-paint-brush"></i> Description</h3>
                        <p class="text-muted">@Model.Description</p>
                        <br>
                        <div class="text-muted">
                            <p class="text-lg">
                                Project Manager
                                <b class="d-block">@projectManager?.FullName</b>
                            </p>
                            @if (User.IsInRole("Administrator"))
                            {
                                <div>
                                    <a asp-action="AssignPM" asp-route-id="@Model.Id" class="btn btn-light">Assign a Project Manager</a>
                                </div>
                            }
                        </div>

                        <br />

                            <div class="card card-cyan">
                                <div class="card-header">
                                    <h3 class="card-title">Tickets</h3>

                                    <div class="card-tools">
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>
                                    <!-- /.card-tools -->
                                </div>
                                <!-- /.card-header -->
                                <div class="card-body">
                                    <ul class="list-unstyled">
                                        @foreach (Ticket ticket in Model.Tickets)
                                        {
                                            <li>
                                                <a asp-controller="Tickets" asp-action="Details" asp-route-id="@ticket.Id" class="text-sm text-white">@ticket.Title</a>
                                            </li>
                                        }
                                    </ul>
                                </div>
                                <!-- /.card-body -->
                            </div>
                            <!-- /.card -->

                        <div class="text-center mt-5 mb-3">
                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#newTicketModal">
                                Add Ticket
                            </button>
                            @if (User.IsInRole("Administrator"))
                            {
                                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-sm btn-warning">Edit Project</a>
                            }
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->

    </section>
    <!-- /.content -->
</div>
<!-- /.content-wrapper -->

<!--Tickets Modal -->
<div class="modal fade" id="newTicketModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Add a New Ticket</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form asp-controller="Tickets" asp-action="Create" method="post">
                <div class="modal-body">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <div class="form-group">
                        <label class="control-label">Title</label>
                        <input name="Title" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input name="Description" class="form-control" />
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>
                    <div>
                        <input type="hidden" asp-for="@Model.Id" name="ProjectId" />
                    </div>
                    <div class="form-group">
                        <label class="control-label">Ticket Type</label>
                        <select name="TicketTypeId" class="form-control" asp-items="ViewBag.TicketStatusId">
                            <option>Select a Type</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Ticket Priority</label>
                        <select name="TicketPriorityId" class="form-control" asp-items="ViewBag.TicketPriorityId">
                            <option>Choose Priority</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" value="Create" class="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!---/.Roles Modal-->

<div>
    <a asp-action="Edit" asp-route-id="@Model.Id">Edit</a> |
    <a asp-action="Dashboard" asp-controller="Home">Back to Dashboard</a>
</div>
